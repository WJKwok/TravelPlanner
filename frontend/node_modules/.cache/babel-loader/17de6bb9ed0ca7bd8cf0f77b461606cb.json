{"ast":null,"code":"var _jsxFileName = \"/Users/wen/Desktop/Projects/React/travelPlanner/client/src/Pages/itinerary.js\";\nimport React, { useState, useContext } from 'react';\nimport { DragDropContext } from 'react-beautiful-dnd';\nimport { useQuery, useMutation } from '@apollo/react-hooks';\nimport gql from 'graphql-tag';\nimport { makeStyles } from '@material-ui/core/styles';\nimport { Button, IconButton } from '@material-ui/core/';\nimport SaveIcon from '@material-ui/icons/Save';\nimport AddCircleOutlineRoundedIcon from '@material-ui/icons/AddCircleOutlineRounded';\nimport DayBoard from '../Components/dayBoard';\nimport CategoryBoard from '../Components/categoryBoard';\nimport Form from '../Components/form';\nimport PlaceAutoComplete from '../Components/placeAutoComplete';\nimport { fetchCategories } from '../Services/googlePlaceApi';\nimport { PlaceContext } from '../Store/PlaceContext';\nconst useStyles = makeStyles({\n  buttonDiv: {\n    display: \"flex\"\n  },\n  buttongRight: {\n    justifyContent: \"flex-end\"\n  },\n  addButton: {\n    \"&:hover\": {\n      backgroundColor: \"transparent\"\n    }\n  }\n});\n\nfunction Itinerary(props) {\n  const {\n    placeState,\n    dispatch\n  } = useContext(PlaceContext);\n  const [itineraryId, setItineraryId] = useState(props.match.params.itineraryId ? props.match.params.itineraryId : \"\");\n  const [saveError, setSaveError] = useState(\"\");\n  const classes = useStyles();\n  /* Causes infinite loop LOL\n  if (props.match.params.itineraryId) {\n      console.log('it is from the link');\n      setItineraryId(props.match.params.itineraryId);\n  };\n  */\n\n  async function fetchItineraryFromGoogle(data) {\n    dispatch({\n      type: \"CLEAR_STATE\"\n    });\n    const googlePlacesApi = process.env.REACT_APP_GOOGLE_PLACES_API_KEY;\n    const dayPlans = data.getItinerary.dayPlans;\n    const city = data.getItinerary.city;\n    let placesFetched = {};\n\n    for (var i = 0; i < dayPlans.length; i++) {\n      const placeIds = dayPlans[i].placeIds; // moved to within reducer\n      // columns[`day-${i}`].placeIds = placeIds\n\n      for (var j = 0; j < placeIds.length; j++) {\n        const response = await fetch(`/place/details/json?placeid=${placeIds[j]}&key=${googlePlacesApi}`);\n        const placeData = await response.json();\n        let placeObject = {};\n        placeObject['id'] = placeIds[j];\n        placeObject['content'] = placeData.result.name;\n        placeObject['rating'] = placeData.result.rating;\n        placeObject['photoRef'] = placeData.result.photos ? placeData.result.photos[0].photo_reference : \"0\";\n        placeObject['location'] = placeData.result.geometry.location;\n        console.log(placeObject); //console.log('every iteration:', Object.keys(placesFetched).length)\n\n        placesFetched[placeIds[j]] = placeObject;\n      }\n    } //console.log(\"before dispatch dataItinerary: \", data.getItinerary);\n    //console.log(\"before dispatch placesFetched: \", Object.keys(placesFetched).length)\n\n\n    dispatch({\n      type: \"LOAD_DAYS\",\n      payload: {\n        itinerary: data.getItinerary,\n        placesFetched\n      }\n    });\n    const placeTypes = ['Restaurants', \"Hotels\", \"Tourist+attraction\"]; //let extraSuggestions = [];\n\n    fetchCategories(placeTypes, city, dispatch); // for (var k = 0; k < placeTypes.length; k++){\n    //     const response = await fetch(`/place/textsearch/json?query=best+${placeTypes[k]}+${city}&key=${googlePlacesApi}`)\n    //     const extraSuggestions = await response.json();\n    //     dispatch({ type:\"LOAD_ITINERARY\", payload:{extraSuggestions, placeType: placeTypes[k]}})\n    // }\n  } // unnecessary if you don't need to access 'data' else where\n  // const { data } = \n\n\n  useQuery(GET_ITINERARY, {\n    // just doen't seem to work\n    // skip: itineraryId !== placeState.itineraryId,\n    onCompleted(data) {\n      // does not run when the component was not remounted and parameter in query does not change\n      if (itineraryId !== placeState.itineraryId) {\n        fetchItineraryFromGoogle(data);\n      }\n    },\n\n    variables: {\n      itineraryId\n    }\n  });\n  /* Tracking Changes in Data\n  While data is from useQuery, it is tagged to an id; and when you update the document via useMutation, this data changes! Even though the 'data' variable is not from there.\n  \n  useEffect(() => {\n      if(data){\n          fetchItineraryFromGoogle();\n      }\n  }, [data])\n  */\n\n  const onDragEnd = result => {\n    const {\n      destination,\n      source,\n      draggableId\n    } = result;\n\n    if (!destination) {\n      return;\n    }\n\n    if (destination.droppableId === source.droppableId && destination.index === source.index) {\n      return;\n    }\n\n    const start = placeState.columns[source.droppableId];\n    const finish = placeState.columns[destination.droppableId]; //if moving within the same column\n\n    if (start === finish) {\n      const column = placeState.columns[source.droppableId];\n      const newplaceIds = Array.from(column.placeIds);\n      newplaceIds.splice(source.index, 1);\n      newplaceIds.splice(destination.index, 0, draggableId);\n      const newColumn = { ...column,\n        placeIds: newplaceIds\n      };\n      const newOrder = { ...placeState,\n        columns: { ...placeState.columns,\n          [newColumn.id]: newColumn\n        }\n      };\n      console.log(newOrder);\n      dispatch({\n        type: 'CHANGE_ORDER',\n        order: {\n          newOrder\n        }\n      });\n      return;\n    } //moving from one list to another\n\n\n    const startplaceIds = Array.from(start.placeIds);\n    startplaceIds.splice(source.index, 1);\n    const newStart = { ...start,\n      placeIds: startplaceIds\n    };\n    const finishplaceIds = Array.from(finish.placeIds);\n    finishplaceIds.splice(destination.index, 0, draggableId);\n    const newFinish = { ...finish,\n      placeIds: finishplaceIds\n    };\n    const newOrder = { ...placeState,\n      columns: { ...placeState.columns,\n        [newStart.id]: newStart,\n        [newFinish.id]: newFinish\n      }\n    };\n    console.log(newOrder);\n    dispatch({\n      type: 'CHANGE_ORDER',\n      order: {\n        newOrder\n      }\n    });\n  };\n\n  let itinerary = [];\n  const mutation = itineraryId ? SAVE_ITINERARY : SUBMIT_ITINERARY;\n  const [submitItinerary] = useMutation(mutation, {\n    // 'result' is the second parameter!\n    update(_, result) {\n      console.log(result.data);\n\n      if (!itineraryId) {\n        setItineraryId(result.data.submitItinerary.id);\n      }\n\n      setSaveError(\"\");\n    },\n\n    onError(err) {\n      setSaveError(err.graphQLErrors[0].extensions.exception.stacktrace[0]);\n    },\n\n    variables: {\n      dayPlans: itinerary,\n      city: placeState.location,\n      id: itineraryId\n    }\n  });\n\n  const addExtraDay = () => {\n    dispatch({\n      type: 'ADD_EXTRA_DAY'\n    });\n  };\n\n  const saveItinerary = () => {\n    const days = placeState.dayBoards;\n\n    for (var i = 0; i < days.length; i++) {\n      itinerary.push({\n        placeIds: placeState.columns[days[i]].placeIds\n      });\n    } //console.log(itinerary);\n\n\n    submitItinerary();\n  };\n\n  console.log(placeState);\n  return React.createElement(\"div\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 231\n    },\n    __self: this\n  }, React.createElement(Form, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 232\n    },\n    __self: this\n  }), itineraryId !== placeState.itineraryId ? React.createElement(\"p\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 233\n    },\n    __self: this\n  }, \"Loading\") : \"\", placeState.days !== 0 ? React.createElement(DragDropContext, {\n    onDragEnd: onDragEnd,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 235\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    className: \"day-and-search\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 236\n    },\n    __self: this\n  }, React.createElement(PlaceAutoComplete, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 237\n    },\n    __self: this\n  }), React.createElement(\"div\", {\n    className: \"day-boards-container\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 239\n    },\n    __self: this\n  }, placeState.dayBoards.map(columnId => {\n    const column = placeState.columns[columnId];\n    const places = column.placeIds.map(placeId => placeState.places[placeId]);\n    return React.createElement(DayBoard, {\n      key: column.id,\n      column: column,\n      places: places,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 246\n      },\n      __self: this\n    });\n  }), placeState.dayBoards.length > 0 ? React.createElement(IconButton, {\n    className: classes.addButton,\n    disableRipple: true,\n    disableFocusRipple: true,\n    onClick: addExtraDay,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 249\n    },\n    __self: this\n  }, React.createElement(AddCircleOutlineRoundedIcon, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 254\n    },\n    __self: this\n  })) : \"\")), React.createElement(\"div\", {\n    className: classes.buttonDiv,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 259\n    },\n    __self: this\n  }, React.createElement(Button, {\n    className: classes.buttonRight,\n    variant: \"outlined\",\n    size: \"medium\",\n    onClick: saveItinerary,\n    startIcon: React.createElement(SaveIcon, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 265\n      },\n      __self: this\n    }),\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 260\n    },\n    __self: this\n  }, \"Save Itinerary\")), saveError ? React.createElement(\"p\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270\n    },\n    __self: this\n  }, saveError) : \"\", placeState.categoryBoards.length > 0 ? React.createElement(\"div\", {\n    className: \"place-boards-container\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 272\n    },\n    __self: this\n  }, placeState.categoryBoards.map(columnId => {\n    const column = placeState.columns[columnId];\n    const places = column.placeIds.map(placeId => placeState.places[placeId]);\n    return React.createElement(CategoryBoard, {\n      key: column.id,\n      column: column,\n      places: places,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 278\n      },\n      __self: this\n    });\n  })) : null) : \"\");\n}\n\nconst SUBMIT_ITINERARY = gql`\n    mutation submitItinerary(\n        $dayPlans: [DayPlanInput]!\n        $city: String!\n    ){\n        submitItinerary(\n            dayPlans: $dayPlans\n            city: $city\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`;\nconst SAVE_ITINERARY = gql`\n    mutation saveItinerary(\n        $id: ID!\n        $dayPlans: [DayPlanInput]!\n    ){\n        saveItinerary(\n            dayPlans: $dayPlans\n            id: $id\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`;\nconst GET_ITINERARY = gql`\n    query getItinerary(\n        $itineraryId: ID!\n    ){\n        getItinerary(\n            itineraryId: $itineraryId\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username \n        }\n    }\n`;\nexport default Itinerary;","map":{"version":3,"sources":["/Users/wen/Desktop/Projects/React/travelPlanner/client/src/Pages/itinerary.js"],"names":["React","useState","useContext","DragDropContext","useQuery","useMutation","gql","makeStyles","Button","IconButton","SaveIcon","AddCircleOutlineRoundedIcon","DayBoard","CategoryBoard","Form","PlaceAutoComplete","fetchCategories","PlaceContext","useStyles","buttonDiv","display","buttongRight","justifyContent","addButton","backgroundColor","Itinerary","props","placeState","dispatch","itineraryId","setItineraryId","match","params","saveError","setSaveError","classes","fetchItineraryFromGoogle","data","type","googlePlacesApi","process","env","REACT_APP_GOOGLE_PLACES_API_KEY","dayPlans","getItinerary","city","placesFetched","i","length","placeIds","j","response","fetch","placeData","json","placeObject","result","name","rating","photos","photo_reference","geometry","location","console","log","payload","itinerary","placeTypes","GET_ITINERARY","onCompleted","variables","onDragEnd","destination","source","draggableId","droppableId","index","start","columns","finish","column","newplaceIds","Array","from","splice","newColumn","newOrder","id","order","startplaceIds","newStart","finishplaceIds","newFinish","mutation","SAVE_ITINERARY","SUBMIT_ITINERARY","submitItinerary","update","_","onError","err","graphQLErrors","extensions","exception","stacktrace","addExtraDay","saveItinerary","days","dayBoards","push","map","columnId","places","placeId","buttonRight","categoryBoards"],"mappings":"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","sourcesContent":["import React, { useState, useContext } from 'react';\nimport { DragDropContext } from 'react-beautiful-dnd';\nimport { useQuery, useMutation } from '@apollo/react-hooks';\nimport gql from 'graphql-tag';\n\nimport { makeStyles } from '@material-ui/core/styles';\nimport { Button, IconButton} from '@material-ui/core/';\nimport SaveIcon from '@material-ui/icons/Save';\nimport AddCircleOutlineRoundedIcon from '@material-ui/icons/AddCircleOutlineRounded';\n\nimport DayBoard from '../Components/dayBoard';\nimport CategoryBoard from '../Components/categoryBoard';\nimport Form from '../Components/form';\nimport PlaceAutoComplete from '../Components/placeAutoComplete'\nimport {fetchCategories} from '../Services/googlePlaceApi'\n\n\nimport { PlaceContext } from '../Store/PlaceContext';\n\n\nconst useStyles = makeStyles({\n    buttonDiv: {\n        display: \"flex\",\n    },\n    buttongRight: {\n        justifyContent: \"flex-end\",\n    },\n    addButton: {\n        \"&:hover\": {\n            backgroundColor: \"transparent\"\n        },\n    },\n})\n\n\nfunction Itinerary(props) {\n\n    const { placeState, dispatch } = useContext(PlaceContext);\n    const [ itineraryId, setItineraryId ] = useState(props.match.params.itineraryId ? props.match.params.itineraryId : \"\");\n    const [ saveError, setSaveError ] = useState(\"\")\n\n    const classes = useStyles();\n    \n    /* Causes infinite loop LOL\n    if (props.match.params.itineraryId) {\n        console.log('it is from the link');\n        setItineraryId(props.match.params.itineraryId);\n    };\n    */\n\n    async function fetchItineraryFromGoogle(data) {\n\n        dispatch({type:\"CLEAR_STATE\"});\n\n        const googlePlacesApi = process.env.REACT_APP_GOOGLE_PLACES_API_KEY;\n        const dayPlans = data.getItinerary.dayPlans;\n        const city = data.getItinerary.city;\n        let placesFetched = {};\n        \n        for(var i = 0; i < dayPlans.length; i++) {\n            const placeIds = dayPlans[i].placeIds\n            // moved to within reducer\n            // columns[`day-${i}`].placeIds = placeIds\n            for(var j = 0; j < placeIds.length; j++){\n                const response = await fetch(`/place/details/json?placeid=${placeIds[j]}&key=${googlePlacesApi}`)\n                const placeData = await response.json();\n\n                let placeObject = {};\n                placeObject['id'] = placeIds[j]\n                placeObject['content'] = placeData.result.name;\n                placeObject['rating'] = placeData.result.rating;\n                placeObject['photoRef'] = placeData.result.photos ? placeData.result.photos[0].photo_reference : \"0\";\n                placeObject['location'] = placeData.result.geometry.location;\n                \n                console.log(placeObject);\n                //console.log('every iteration:', Object.keys(placesFetched).length)\n                placesFetched[placeIds[j]] = placeObject;\n            }\n        }\n        //console.log(\"before dispatch dataItinerary: \", data.getItinerary);\n        //console.log(\"before dispatch placesFetched: \", Object.keys(placesFetched).length)\n        dispatch({ type:\"LOAD_DAYS\", payload:{itinerary: data.getItinerary, placesFetched}})\n\n        const placeTypes = ['Restaurants', \"Hotels\", \"Tourist+attraction\"];\n        //let extraSuggestions = [];\n\n        fetchCategories(placeTypes, city, dispatch);\n        // for (var k = 0; k < placeTypes.length; k++){\n        //     const response = await fetch(`/place/textsearch/json?query=best+${placeTypes[k]}+${city}&key=${googlePlacesApi}`)\n        //     const extraSuggestions = await response.json();\n        //     dispatch({ type:\"LOAD_ITINERARY\", payload:{extraSuggestions, placeType: placeTypes[k]}})\n        // }\n\n    }\n\n    // unnecessary if you don't need to access 'data' else where\n    // const { data } = \n    useQuery(GET_ITINERARY, {\n        // just doen't seem to work\n        // skip: itineraryId !== placeState.itineraryId,\n        onCompleted(data){\n            // does not run when the component was not remounted and parameter in query does not change\n            if (itineraryId !== placeState.itineraryId){\n                fetchItineraryFromGoogle(data);\n            }\n        },\n        variables: {itineraryId}\n    })\n\n    /* Tracking Changes in Data\n    While data is from useQuery, it is tagged to an id; and when you update the document via useMutation, this data changes! Even though the 'data' variable is not from there.\n    \n    useEffect(() => {\n        if(data){\n            fetchItineraryFromGoogle();\n        }\n    }, [data])\n    */\n\n    const onDragEnd = result => {\n        const { destination, source, draggableId } = result;\n\n        if (!destination) {\n            return;\n        }\n\n        if (\n            destination.droppableId === source.droppableId &&\n            destination.index === source.index\n        ) {\n            return;\n        }\n\n        const start = placeState.columns[source.droppableId];\n        const finish = placeState.columns[destination.droppableId];\n\n        //if moving within the same column\n        if (start === finish) {\n            const column = placeState.columns[source.droppableId];\n            const newplaceIds = Array.from(column.placeIds);\n            newplaceIds.splice(source.index, 1);\n            newplaceIds.splice(destination.index, 0, draggableId);\n\n            const newColumn = {\n                ...column,\n                placeIds: newplaceIds,\n            };\n\n            const newOrder = {\n                ...placeState,\n                columns: {\n                    ...placeState.columns,\n                    [newColumn.id]: newColumn,\n                },\n            };\n            console.log(newOrder);\n            dispatch({ type:'CHANGE_ORDER', order: {newOrder}});\n            return;\n        }\n\n        //moving from one list to another\n        const startplaceIds = Array.from(start.placeIds);\n        startplaceIds.splice(source.index, 1);\n        const newStart = {\n            ...start,\n            placeIds: startplaceIds,\n        };\n\n        const finishplaceIds = Array.from(finish.placeIds);\n        finishplaceIds.splice(destination.index, 0, draggableId);\n        const newFinish = {\n            ...finish,\n            placeIds: finishplaceIds,\n        };\n\n\n        const newOrder = {\n            ...placeState,\n            columns: {\n                ...placeState.columns,\n                [newStart.id]: newStart,\n                [newFinish.id]: newFinish,\n            },\n        };\n\n        console.log(newOrder);\n        dispatch({ type:'CHANGE_ORDER', order: {newOrder}});\n    };\n\n    let itinerary = [];\n    const mutation = itineraryId ? SAVE_ITINERARY : SUBMIT_ITINERARY;\n    const [submitItinerary] = useMutation(mutation, {\n        // 'result' is the second parameter!\n        update(_, result){\n            console.log(result.data);\n\n            if (!itineraryId) {\n                setItineraryId(result.data.submitItinerary.id)\n            }\n            setSaveError(\"\");\n        },\n        onError(err){\n            setSaveError(err.graphQLErrors[0].extensions.exception.stacktrace[0]);\n        },\n        variables: {\n            dayPlans: itinerary,\n            city: placeState.location,\n            id: itineraryId\n        }\n    })\n\n    const addExtraDay = () => {\n        dispatch({type:'ADD_EXTRA_DAY'});\n    }\n\n    const saveItinerary = () => {\n        const days = placeState.dayBoards;\n        for (var i = 0; i < days.length; i ++){\n            itinerary.push({\n                placeIds: placeState.columns[days[i]].placeIds\n            });\n            \n        }\n        //console.log(itinerary);\n        submitItinerary();\n    }\n\n    console.log(placeState);\n\n    return (\n        <div>\n            <Form/>\n            {itineraryId !== placeState.itineraryId ? <p>Loading</p> : \"\"}\n            {placeState.days !== 0 \n            ? <DragDropContext onDragEnd={onDragEnd}>\n                <div className='day-and-search'>\n                    <PlaceAutoComplete/>\n                    \n                    <div className='day-boards-container'>\n                        {placeState.dayBoards.map(columnId => {\n                            const column = placeState.columns[columnId];\n                            const places = column.placeIds.map(placeId => \n                                placeState.places[placeId]\n                            );\n\n                            return <DayBoard key={column.id} column={column} places={places}/>\n                        })}\n                        {placeState.dayBoards.length > 0 ?\n                            <IconButton \n                                className={classes.addButton}\n                                disableRipple={true}\n                                disableFocusRipple={true}\n                                onClick={addExtraDay}>\n                                <AddCircleOutlineRoundedIcon />\n                            </IconButton>\n                            : \"\"}\n                    </div>\n                </div>\n                <div className={classes.buttonDiv}>\n                    <Button \n                        className={classes.buttonRight}\n                        variant=\"outlined\" \n                        size=\"medium\" \n                        onClick={saveItinerary}\n                        startIcon={<SaveIcon />}\n                    >\n                            Save Itinerary\n                    </Button>\n                </div>\n                {saveError ? <p>{saveError}</p> : \"\"}\n                {placeState.categoryBoards.length > 0 \n                ? <div className='place-boards-container'>\n                    {placeState.categoryBoards.map(columnId => {\n                        const column = placeState.columns[columnId];\n                        const places = column.placeIds.map(placeId => \n                            placeState.places[placeId]\n                        );\n                        return <CategoryBoard key={column.id} column={column} places={places}/>\n                    })}\n                </div>\n                : null}\n                \n            </DragDropContext>\n            : \"\"}\n        </div>\n        \n    );\n\n}\n\nconst SUBMIT_ITINERARY =  gql`\n    mutation submitItinerary(\n        $dayPlans: [DayPlanInput]!\n        $city: String!\n    ){\n        submitItinerary(\n            dayPlans: $dayPlans\n            city: $city\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`\n\nconst SAVE_ITINERARY = gql`\n    mutation saveItinerary(\n        $id: ID!\n        $dayPlans: [DayPlanInput]!\n    ){\n        saveItinerary(\n            dayPlans: $dayPlans\n            id: $id\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`\n\nconst GET_ITINERARY = gql`\n    query getItinerary(\n        $itineraryId: ID!\n    ){\n        getItinerary(\n            itineraryId: $itineraryId\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username \n        }\n    }\n`\n\nexport default Itinerary;"]},"metadata":{},"sourceType":"module"}