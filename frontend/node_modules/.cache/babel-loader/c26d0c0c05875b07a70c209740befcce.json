{"ast":null,"code":"var _jsxFileName = \"/Users/wen/Desktop/Projects/React/travelPlanner/client/src/Components/page.js\";\nimport React, { useState, useContext, useEffect } from 'react';\nimport { DragDropContext } from 'react-beautiful-dnd';\nimport { useQuery, useMutation } from '@apollo/react-hooks';\nimport gql from 'graphql-tag';\nimport DayBoard from './dayBoard';\nimport CategoryBoard from './categoryBoard';\nimport Form from './form';\nimport { PlaceContext } from '../Store/PlaceContext';\n\nfunction Page(props) {\n  const {\n    placeState,\n    dispatch\n  } = useContext(PlaceContext);\n  const [itineraryId, setItineraryId] = useState(props.match.params.itineraryId);\n  const skipQuery = itineraryId == placeState.itineraryId; // if (props.match.params.itineraryId) {\n  //     console.log('it is from the link');\n  //     setItineraryId(props.match.params.itineraryId);\n  // };\n\n  console.log(itineraryId);\n\n  async function fetchItineraryFromGoogle(data) {\n    const googlePlacesApi = process.env.REACT_APP_GOOGLE_PLACES_API_KEY;\n    const dayPlans = data.getItinerary.dayPlans;\n    const city = data.getItinerary.city;\n    let placesFetched = {};\n\n    for (var i = 0; i < dayPlans.length; i++) {\n      const placeIds = dayPlans[i].placeIds; //columns[`day-${i}`].placeIds = placeIds\n      //moved to within reducer\n\n      for (var j = 0; j < placeIds.length; j++) {\n        const response = await fetch(`/place/details/json?placeid=${placeIds[j]}&key=${googlePlacesApi}`);\n        const placeData = await response.json();\n        let placeObject = {};\n        placeObject['id'] = placeIds[j];\n        placeObject['content'] = placeData.result.name;\n        placeObject['rating'] = placeData.result.rating;\n        placeObject['photoRef'] = placeData.result.photos ? placeData.result.photos[0].photo_reference : \"0\";\n        placeObject['location'] = placeData.result.geometry.location;\n        console.log(placeObject);\n        placesFetched[placeIds[j]] = placeObject;\n      }\n    }\n\n    const placeTypes = ['Restaurants', \"Hotels\", \"Tourist+attraction\"];\n    let extraSuggestions = [];\n\n    for (var i = 0; i < placeTypes.length; i++) {\n      const response = await fetch(`/place/textsearch/json?query=best+${placeTypes[i]}+${city}&key=${googlePlacesApi}`);\n      const data = await response.json();\n      extraSuggestions.push(data);\n    }\n\n    dispatch({\n      type: \"LOAD_ITINERARY\",\n      payload: {\n        itinerary: data.getItinerary,\n        placesFetched,\n        extraSuggestions\n      }\n    });\n  } //console.log(\"is it the same id? \", itineraryId == placeState.itineraryId);\n\n\n  const {\n    data\n  } = useQuery(GET_ITINERARY, {\n    skip: skipQuery,\n\n    onCompleted(data) {\n      fetchItineraryFromGoogle(data);\n    },\n\n    variables: {\n      itineraryId\n    }\n  }); //Tracking Changes in Data\n  //while data is from useQuery, it is tagged to an id and when you update the document via useMutation, the data changes! Even though the variable is not from there.\n  // useEffect(() => {\n  //     if(data){\n  //         fetchItineraryFromGoogle();\n  //     }\n  // }, [data])\n\n  const onDragEnd = result => {\n    const {\n      destination,\n      source,\n      draggableId\n    } = result;\n\n    if (!destination) {\n      return;\n    }\n\n    if (destination.droppableId === source.droppableId && destination.index === source.index) {\n      return;\n    }\n\n    const start = placeState.columns[source.droppableId];\n    const finish = placeState.columns[destination.droppableId]; //if moving within the same column\n\n    if (start === finish) {\n      const column = placeState.columns[source.droppableId];\n      const newplaceIds = Array.from(column.placeIds);\n      newplaceIds.splice(source.index, 1);\n      newplaceIds.splice(destination.index, 0, draggableId);\n      const newColumn = { ...column,\n        placeIds: newplaceIds\n      };\n      const newOrder = { ...placeState,\n        columns: { ...placeState.columns,\n          [newColumn.id]: newColumn\n        }\n      };\n      console.log(newOrder);\n      dispatch({\n        type: 'CHANGE_ORDER',\n        order: {\n          newOrder\n        }\n      });\n      return;\n    } //moving from one list to another\n\n\n    const startplaceIds = Array.from(start.placeIds);\n    startplaceIds.splice(source.index, 1);\n    const newStart = { ...start,\n      placeIds: startplaceIds\n    };\n    const finishplaceIds = Array.from(finish.placeIds);\n    finishplaceIds.splice(destination.index, 0, draggableId);\n    const newFinish = { ...finish,\n      placeIds: finishplaceIds\n    };\n    const newOrder = { ...placeState,\n      columns: { ...placeState.columns,\n        [newStart.id]: newStart,\n        [newFinish.id]: newFinish\n      }\n    };\n    console.log(newOrder);\n    dispatch({\n      type: 'CHANGE_ORDER',\n      order: {\n        newOrder\n      }\n    });\n  };\n\n  let itinerary = [];\n  const mutation = itineraryId ? SAVE_ITINERARY : SUBMIT_ITINERARY;\n  const [submitItinerary] = useMutation(mutation, {\n    // result is the second parameter!\n    update(_, result) {\n      console.log(result.data);\n\n      if (!itineraryId) {\n        setItineraryId(result.data.submitItinerary.id);\n      }\n    },\n\n    onError(err) {\n      console.log(err);\n    },\n\n    variables: {\n      dayPlans: itinerary,\n      city: placeState.location,\n      id: itineraryId\n    }\n  });\n\n  const addExtraDay = () => {\n    dispatch({\n      type: 'ADD_EXTRA_DAY'\n    });\n  };\n\n  const saveItinerary = () => {\n    const days = placeState.dayBoards;\n\n    for (var i = 0; i < days.length; i++) {\n      itinerary.push({\n        placeIds: placeState.columns[days[i]].placeIds\n      });\n    } //console.log(itinerary);\n\n\n    submitItinerary();\n  };\n\n  console.log(placeState);\n  return React.createElement(\"div\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 193\n    },\n    __self: this\n  }, React.createElement(Form, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 194\n    },\n    __self: this\n  }), itineraryId !== placeState.itineraryId ? React.createElement(\"p\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195\n    },\n    __self: this\n  }, \"Loading\") : React.createElement(\"p\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195\n    },\n    __self: this\n  }, \"Loaded\"), React.createElement(DragDropContext, {\n    onDragEnd: onDragEnd,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 196\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    className: \"day-boards-container\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 197\n    },\n    __self: this\n  }, placeState.dayBoards.map(columnId => {\n    const column = placeState.columns[columnId];\n    const places = column.placeIds.map(placeId => placeState.places[placeId]);\n    return React.createElement(DayBoard, {\n      key: column.id,\n      column: column,\n      places: places,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 204\n      },\n      __self: this\n    });\n  }), placeState.dayBoards.length > 0 ? React.createElement(\"button\", {\n    className: \"extra-day\",\n    onClick: addExtraDay,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 206\n    },\n    __self: this\n  }, \"+\") : \"\"), React.createElement(\"button\", {\n    onClick: saveItinerary,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 209\n    },\n    __self: this\n  }, \"Save Itinerary\"), React.createElement(\"div\", {\n    className: \"place-boards-container\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 210\n    },\n    __self: this\n  }, placeState.categoryBoards.map(columnId => {\n    const column = placeState.columns[columnId];\n    const places = column.placeIds.map(placeId => placeState.places[placeId]);\n    return React.createElement(CategoryBoard, {\n      key: column.id,\n      column: column,\n      places: places,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 217\n      },\n      __self: this\n    });\n  }))));\n}\n\nconst SUBMIT_ITINERARY = gql`\n    mutation submitItinerary(\n        $dayPlans: [DayPlanInput]!\n        $city: String!\n    ){\n        submitItinerary(\n            dayPlans: $dayPlans\n            city: $city\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`;\nconst SAVE_ITINERARY = gql`\n    mutation saveItinerary(\n        $id: ID!\n        $dayPlans: [DayPlanInput]!\n    ){\n        saveItinerary(\n            dayPlans: $dayPlans\n            id: $id\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`;\nconst GET_ITINERARY = gql`\n    query getItinerary(\n        $itineraryId: ID!\n    ){\n        getItinerary(\n            itineraryId: $itineraryId\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username \n        }\n    }\n`;\nexport default Page;","map":{"version":3,"sources":["/Users/wen/Desktop/Projects/React/travelPlanner/client/src/Components/page.js"],"names":["React","useState","useContext","useEffect","DragDropContext","useQuery","useMutation","gql","DayBoard","CategoryBoard","Form","PlaceContext","Page","props","placeState","dispatch","itineraryId","setItineraryId","match","params","skipQuery","console","log","fetchItineraryFromGoogle","data","googlePlacesApi","process","env","REACT_APP_GOOGLE_PLACES_API_KEY","dayPlans","getItinerary","city","placesFetched","i","length","placeIds","j","response","fetch","placeData","json","placeObject","result","name","rating","photos","photo_reference","geometry","location","placeTypes","extraSuggestions","push","type","payload","itinerary","GET_ITINERARY","skip","onCompleted","variables","onDragEnd","destination","source","draggableId","droppableId","index","start","columns","finish","column","newplaceIds","Array","from","splice","newColumn","newOrder","id","order","startplaceIds","newStart","finishplaceIds","newFinish","mutation","SAVE_ITINERARY","SUBMIT_ITINERARY","submitItinerary","update","_","onError","err","addExtraDay","saveItinerary","days","dayBoards","map","columnId","places","placeId","categoryBoards"],"mappings":"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","sourcesContent":["import React, { useState, useContext, useEffect } from 'react';\nimport { DragDropContext } from 'react-beautiful-dnd';\nimport { useQuery, useMutation } from '@apollo/react-hooks';\nimport gql from 'graphql-tag';\n\nimport DayBoard from './dayBoard';\nimport CategoryBoard from './categoryBoard';\nimport Form from './form';\n\nimport { PlaceContext } from '../Store/PlaceContext';\n\nfunction Page(props) {\n\n    const { placeState, dispatch } = useContext(PlaceContext);\n    const [ itineraryId, setItineraryId ] = useState(props.match.params.itineraryId);\n    const skipQuery = itineraryId == placeState.itineraryId;\n    // if (props.match.params.itineraryId) {\n    //     console.log('it is from the link');\n    //     setItineraryId(props.match.params.itineraryId);\n    // };\n\n    console.log(itineraryId);\n\n    async function fetchItineraryFromGoogle(data) {\n\n        const googlePlacesApi = process.env.REACT_APP_GOOGLE_PLACES_API_KEY;\n        const dayPlans = data.getItinerary.dayPlans;\n        const city = data.getItinerary.city;\n        let placesFetched = {};\n        \n        for(var i = 0; i < dayPlans.length; i++) {\n            const placeIds = dayPlans[i].placeIds\n            //columns[`day-${i}`].placeIds = placeIds\n            //moved to within reducer\n            for(var j = 0; j < placeIds.length; j++){\n                const response = await fetch(`/place/details/json?placeid=${placeIds[j]}&key=${googlePlacesApi}`)\n                const placeData = await response.json();\n\n                let placeObject = {};\n                placeObject['id'] = placeIds[j]\n                placeObject['content'] = placeData.result.name;\n                placeObject['rating'] = placeData.result.rating;\n                placeObject['photoRef'] = placeData.result.photos ? placeData.result.photos[0].photo_reference : \"0\";\n                placeObject['location'] = placeData.result.geometry.location;\n                \n                console.log(placeObject);\n                placesFetched[placeIds[j]] = placeObject;\n            }\n        }\n\n        const placeTypes = ['Restaurants', \"Hotels\", \"Tourist+attraction\"];\n        let extraSuggestions = [];\n\n        for (var i = 0; i < placeTypes.length; i++){\n            const response = await fetch(`/place/textsearch/json?query=best+${placeTypes[i]}+${city}&key=${googlePlacesApi}`)\n            const data = await response.json();\n            extraSuggestions.push(data);\n        }\n\n        dispatch({ type:\"LOAD_ITINERARY\", payload:{itinerary: data.getItinerary, placesFetched, extraSuggestions}})\n    }\n\n    //console.log(\"is it the same id? \", itineraryId == placeState.itineraryId);\n    const { data } = useQuery(GET_ITINERARY, {\n        skip: skipQuery,\n        onCompleted(data){\n            fetchItineraryFromGoogle(data);\n        },\n        variables: {itineraryId}\n    })\n\n\n    //Tracking Changes in Data\n    //while data is from useQuery, it is tagged to an id and when you update the document via useMutation, the data changes! Even though the variable is not from there.\n    \n    // useEffect(() => {\n    //     if(data){\n    //         fetchItineraryFromGoogle();\n    //     }\n    // }, [data])\n\n\n    const onDragEnd = result => {\n        const { destination, source, draggableId } = result;\n\n        if (!destination) {\n            return;\n        }\n\n        if (\n            destination.droppableId === source.droppableId &&\n            destination.index === source.index\n        ) {\n            return;\n        }\n\n        const start = placeState.columns[source.droppableId];\n        const finish = placeState.columns[destination.droppableId];\n\n        //if moving within the same column\n        if (start === finish) {\n            const column = placeState.columns[source.droppableId];\n            const newplaceIds = Array.from(column.placeIds);\n            newplaceIds.splice(source.index, 1);\n            newplaceIds.splice(destination.index, 0, draggableId);\n\n            const newColumn = {\n                ...column,\n                placeIds: newplaceIds,\n            };\n\n            const newOrder = {\n                ...placeState,\n                columns: {\n                    ...placeState.columns,\n                    [newColumn.id]: newColumn,\n                },\n            };\n            console.log(newOrder);\n            dispatch({ type:'CHANGE_ORDER', order: {newOrder}});\n            return;\n        }\n\n        //moving from one list to another\n        const startplaceIds = Array.from(start.placeIds);\n        startplaceIds.splice(source.index, 1);\n        const newStart = {\n            ...start,\n            placeIds: startplaceIds,\n        };\n\n        const finishplaceIds = Array.from(finish.placeIds);\n        finishplaceIds.splice(destination.index, 0, draggableId);\n        const newFinish = {\n            ...finish,\n            placeIds: finishplaceIds,\n        };\n\n\n        const newOrder = {\n            ...placeState,\n            columns: {\n                ...placeState.columns,\n                [newStart.id]: newStart,\n                [newFinish.id]: newFinish,\n            },\n        };\n\n        console.log(newOrder);\n        dispatch({ type:'CHANGE_ORDER', order: {newOrder}});\n    };\n\n    let itinerary = [];\n    const mutation = itineraryId ? SAVE_ITINERARY : SUBMIT_ITINERARY;\n    const [submitItinerary] = useMutation(mutation, {\n        // result is the second parameter!\n        update(_, result){\n            console.log(result.data);\n\n            if (!itineraryId) {\n                setItineraryId(result.data.submitItinerary.id)\n            }\n        },\n        onError(err){\n            console.log(err)\n        },\n        variables: {\n            dayPlans: itinerary,\n            city: placeState.location,\n            id: itineraryId\n        }\n    })\n\n    const addExtraDay = () => {\n        dispatch({type:'ADD_EXTRA_DAY'});\n    }\n\n    const saveItinerary = () => {\n        const days = placeState.dayBoards;\n        for (var i = 0; i < days.length; i ++){\n            itinerary.push({\n                placeIds: placeState.columns[days[i]].placeIds\n            });\n            \n        }\n        //console.log(itinerary);\n        submitItinerary();\n    }\n\n    console.log(placeState);\n\n    return (\n        <div>\n            <Form/>\n            {itineraryId !== placeState.itineraryId ? <p>Loading</p> : <p>Loaded</p>}\n            <DragDropContext onDragEnd={onDragEnd}>\n                <div className='day-boards-container'>\n                    {placeState.dayBoards.map(columnId => {\n                        const column = placeState.columns[columnId];\n                        const places = column.placeIds.map(placeId => \n                            placeState.places[placeId]\n                        );\n\n                        return <DayBoard key={column.id} column={column} places={places}/>\n                    })}\n                    {placeState.dayBoards.length > 0 ? <button className=\"extra-day\" onClick={addExtraDay}>+</button> : \"\"}\n                    \n                </div>\n                <button onClick={saveItinerary}>Save Itinerary</button>\n                <div className='place-boards-container'>\n                    {placeState.categoryBoards.map(columnId => {\n                        const column = placeState.columns[columnId];\n                        const places = column.placeIds.map(placeId => \n                            placeState.places[placeId]\n                        );\n\n                        return <CategoryBoard key={column.id} column={column} places={places}/>\n                    })}\n                </div>\n            </DragDropContext>\n        </div>\n        \n    );\n\n}\n\nconst SUBMIT_ITINERARY =  gql`\n    mutation submitItinerary(\n        $dayPlans: [DayPlanInput]!\n        $city: String!\n    ){\n        submitItinerary(\n            dayPlans: $dayPlans\n            city: $city\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`\n\nconst SAVE_ITINERARY = gql`\n    mutation saveItinerary(\n        $id: ID!\n        $dayPlans: [DayPlanInput]!\n    ){\n        saveItinerary(\n            dayPlans: $dayPlans\n            id: $id\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username\n        }\n    }\n`\n\nconst GET_ITINERARY = gql`\n    query getItinerary(\n        $itineraryId: ID!\n    ){\n        getItinerary(\n            itineraryId: $itineraryId\n        ){\n            id\n            city\n            dayPlans{\n                placeIds\n            }\n            createdAt\n            user\n            username \n        }\n    }\n`\n\nexport default Page;"]},"metadata":{},"sourceType":"module"}